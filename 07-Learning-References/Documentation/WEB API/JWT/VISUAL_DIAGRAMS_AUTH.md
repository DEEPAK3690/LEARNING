# ?? Visual Diagrams: Authentication & Authorization

## ?? Complete Flow Diagram

```
????????????????????????????????????????????????????????????????????
?                        USER'S BROWSER                             ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ? 1. Enter username & password
                                  ?
????????????????????????????????????????????????????????????????????
?              POST /api/auth/login                                 ?
?              {username, password}                                 ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?                    AUTHENTICATION LAYER                           ?
?  ??????????????????????????????????????????????????????????????  ?
?  ? 1. Find user in database                                  ?  ?
?  ? 2. Hash password using bcrypt                             ?  ?
?  ? 3. Compare with stored hash                               ?  ?
?  ? 4. If match ? Proceed; If not ? Return 401               ?  ?
?  ??????????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                                  ?
                    ? Credentials Valid
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?                   TOKEN GENERATION                                ?
?  ??????????????????????????????????????????????????????????????  ?
?  ? Create JWT Token with:                                    ?  ?
?  ? - User ID: 1                                              ?  ?
?  ? - Username: admin                                         ?  ?
?  ? - Email: admin@example.com                                ?  ?
?  ? - Role: Admin          ? Authorization data               ?  ?
?  ? - Expires: +60 minutes                                    ?  ?
?  ? - Sign with secret key                                    ?  ?
?  ??????????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?               Return Token to Client                              ?
?         {token: "eyJhbGci...", role: "Admin"}                    ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?                   BROWSER STORAGE                                 ?
?         Token saved in localStorage/sessionStorage                ?
?                 ?                                                  ?
?         Authorization: Bearer {token}                            ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ? 2. Send token with each request
                                  ?
????????????????????????????????????????????????????????????????????
?          GET /api/employee?id=1                                   ?
?          Header: Authorization: Bearer {token}                    ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?                    TOKEN VALIDATION                               ?
?  ??????????????????????????????????????????????????????????????  ?
?  ? 1. Extract token from Authorization header                ?  ?
?  ? 2. Verify signature (not tampered)                         ?  ?
?  ? 3. Check expiration time                                   ?  ?
?  ? 4. Extract claims (user data)                              ?  ?
?  ? 5. If valid ? Proceed; If not ? Return 401                ?  ?
?  ??????????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                                  ?
                        ? Token Valid
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?              AUTHORIZATION CHECK (Role Check)                     ?
?  ??????????????????????????????????????????????????????????????  ?
?  ? GET /api/employee requires:                               ?  ?
?  ? [Authorize(Roles = "Admin, Manager, Employee")]           ?  ?
?  ?                                                             ?  ?
?  ? Token contains: Role = "Admin"                             ?  ?
?  ?                                                             ?  ?
?  ? Is Admin in [Admin, Manager, Employee]? YES ?             ?  ?
?  ? ? Allow request                                            ?  ?
?  ??????????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                                  ?
                        ? Authorization Passed
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?              EXECUTE ENDPOINT LOGIC                               ?
?  GetAllEmployees() ? Retrieve from database ? Return JSON        ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?               Response: 200 OK + Employee List                    ?
????????????????????????????????????????????????????????????????????
```

---

## ? Failed Authorization Diagram

```
????????????????????????????????????????????????????????????????????
?  DELETE /api/employee/1                                           ?
?  Authorization: Bearer {EMPLOYEE_TOKEN}                           ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?                    TOKEN VALIDATION                               ?
?  ? Token is valid (signature correct, not expired)               ?
?  ? User is authenticated (token verified)                        ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?          AUTHORIZATION CHECK (Role Check)                         ?
?  ??????????????????????????????????????????????????????????????  ?
?  ? DELETE /api/employee/{id} requires:                        ?  ?
?  ? [Authorize(Roles = "Admin")]                               ?  ?
?  ?                                                             ?  ?
?  ? Token contains: Role = "Employee"                          ?  ?
?  ?                                                             ?  ?
?  ? Is Employee in [Admin]? NO ?                               ?  ?
?  ? ? DENY request                                             ?  ?
?  ??????????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
????????????????????????????????????????????????????????????????????
?               Response: 403 FORBIDDEN                              ?
?  {                                                                 ?
?    "status": 403,                                                  ?
?    "detail": "Access Denied. User must be in role: Admin"         ?
?  }                                                                 ?
????????????????????????????????????????????????????????????????????
```

---

## ?? JWT Token Structure

```
Original JWT:
?????????????????????????????????????????????????????????????????
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
eyJzdWIiOiIxIiwibmFtZSI6ImFkbWluIiwicm9sZSI6IkFkbWluIiwiaWF0IjoxNTE2MjM5MDIyfQ.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
?????????????????????????????????????????????????????????????????

Decoded into 3 parts:

???????????????????????????????????
?          PART 1: HEADER          ?
???????????????????????????????????
{
  "alg": "HS256",     ? Algorithm for signature
  "typ": "JWT"        ? Type of token
}

Base64 Encoded:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9


???????????????????????????????????
?         PART 2: PAYLOAD          ?
???????????????????????????????????
{
  "sub": "1",                      ? Subject (User ID)
  "name": "admin",                 ? Username
  "role": "Admin",                 ? AUTHORIZATION INFO!
  "email": "admin@example.com",    ? Email
  "iat": 1516239022,               ? Issued at time
  "exp": 1516325422                ? Expiration time
}

Base64 Encoded:
eyJzdWIiOiIxIiwibmFtZSI6ImFkbWluIiwicm9sZSI6IkFkbWluIiwiaWF0IjoxNTE2MjM5MDIyfQ


???????????????????????????????????
?       PART 3: SIGNATURE          ?
???????????????????????????????????

Created by:
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret_key
)

Result:
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

Purpose: ? Verify token hasn't been modified
         ? Prove server created this token
```

---

## ??? How JWT Signature Works

### Scenario 1: Valid Token (Not Tampered)

```
???????????????????????????????????????????????????
?         SERVER RECEIVES TOKEN                    ?
???????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????
?     Extract Header, Payload, Signature          ?
???????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????
?  Recreate Signature:                            ?
?  HMACSHA256(header.payload, secret_key)         ?
?  Result: SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV... ?
???????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????
?  Compare:                                       ?
?  Recreated: SflKxwRJSMeKKF2QT4fwpMeJf36POk6... ?
?  Token:     SflKxwRJSMeKKF2QT4fwpMeJf36POk6... ?
?                                                 ?
?  ? MATCH! Token is authentic                   ?
???????????????????????????????????????????????????
                   ?
                   ?
        ? Allow request to proceed
```

### Scenario 2: Tampered Token

```
???????????????????????????????????????????????????
?  ATTACKER MODIFIES TOKEN                        ?
?  Original Payload: role: "Employee"             ?
?  Modified Payload: role: "Admin"                ?
???????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????
?         SERVER RECEIVES TOKEN                    ?
?  Signature is old (for Employee)                ?
?  Payload is new (Admin)                         ?
?  MISMATCH!                                      ?
???????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????
?  Recreate Signature:                            ?
?  HMACSHA256(modified_header.modified_payload,   ?
?  secret_key)                                    ?
?  Result: DifferentSignature...                  ?
???????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????
?  Compare:                                       ?
?  Recreated: DifferentSignature...               ?
?  Token:     OldSignature...                     ?
?                                                 ?
?  ? NO MATCH! Token is invalid                  ?
???????????????????????????????????????????????????
                   ?
                   ?
        ? Reject request ? 401 Unauthorized
```

---

## ?? Role-Based Access Control (RBAC) Matrix

```
                  ?  Admin  ? Manager ? Employee ? Guest
?????????????????????????????????????????????????????????
GET /employee     ?   ?    ?   ?    ?    ?    ?  ?
POST /employee    ?   ?    ?   ?    ?    ?    ?  ?
PUT /employee/{id}?   ?    ?   ?    ?    ?    ?  ?
DELETE /employee  ?   ?    ?   ?    ?    ?    ?  ?
GET /report       ?   ?    ?   ?    ?    ?    ?  ?
POST /report      ?   ?    ?   ?    ?    ?    ?  ?
DELETE /report    ?   ?    ?   ?    ?    ?    ?  ?

Legend:
? = Allowed
? = Forbidden (403) or Unauthorized (401)
```

---

## ?? Request Lifecycle

```
Request with Token
        ?
        ?
????????????????????????????????
?   Is Authorization header    ? NO
?        present?              ????????????????????
????????????????????????????????                  ?
        YES                                       ?
         ?                                        ?
         ?                                        ?
????????????????????????????????    ????????????????????????
?  Is token format valid?      ? NO ?  401 Unauthorized    ?
?  (Bearer {token})            ??????  "No token found"    ?
????????????????????????????????    ????????????????????????
        YES
         ?
         ?
????????????????????????????????
?  Is token signature valid?   ? NO
?  (Verify with secret key)    ????????????????????
????????????????????????????????                  ?
        YES                                       ?
         ?                                        ?
         ?                                        ?
????????????????????????????????    ????????????????????????
?  Is token expired?           ?YES ?  401 Unauthorized    ?
?  (Check exp time)            ??????  "Token expired"     ?
????????????????????????????????    ????????????????????????
        NO
         ?
         ?
????????????????????????????????
?  Extract role from payload   ?
????????????????????????????????
         ?
         ?
????????????????????????????????
?  Does endpoint have          ? NO
?  [Authorize] attribute?      ????????????????????
????????????????????????????????                  ?
        YES                                       ?
         ?                                        ?
         ?                                  ????????????????????????
????????????????????????????????           ? 200 OK               ?
?  Does role match required    ? NO        ? (No auth required)   ?
?  role(s)?                    ??????      ????????????????????????
????????????????????????????????    ?
        YES                         ?
         ?                          ?
         ?                   ????????????????????????
???????????????????????????????? ?  403 Forbidden     ?
?  200 OK                      ? ?  "Access denied"   ?
?  Execute endpoint logic      ? ????????????????????????
?  Return response             ?
????????????????????????????????
```

---

## ?? Multi-Service Architecture

```
????????????????????????????????????????????????????????????????
?                    CLIENT APPLICATION                         ?
?                    (Web Browser / Mobile)                     ?
????????????????????????????????????????????????????????????????
                            ?
                 ???????????????????????
                 ?          ?          ?
                 ?          ?          ?
        ??????????????? ?????????? ????????????
        ? Auth        ? ?Report  ? ?Employee  ?
        ? Service     ? ?Service ? ?Service   ?
        ? (Port 5001) ? ?(5002)  ? ?(5003)    ?
        ??????????????? ?????????? ????????????
                 ?          ?          ?
                 ?          ?          ?
                 ???????????????????????
                            ?
         ???????????????????????????????????????
         ?                                     ?
         ?                                     ?
????????????????????????????      ????????????????????????
?  Centralized Auth        ?      ?  JWT Token           ?
?  - User validation       ?      ?  - Same token works  ?
?  - Token generation      ?      ?  - On all services   ?
?  - Password hashing      ?      ?  - No session sync   ?
????????????????????????????      ????????????????????????

All services trust the same JWT secret key!
```

---

## ? Token Lifecycle

```
User Login
    ?
    ?
???????????????????????????????????????
?  Token Generated                    ?
?  Issued At: 2:00 PM                 ?
?  Expires At: 3:00 PM                ?
?  (60 minutes)                       ?
???????????????????????????????????????
    ?
    ???????????????????????????????????????????????????????????
    ?                                                         ?
    ? 2:15 PM                                                 ?
???????????????????????????????????????                      ?
?  Token Valid                        ?                      ?
?  Status: ? VALID                   ?                      ?
?  Can use in requests                ?                      ?
???????????????????????????????????????                      ?
    ?                                                         ?
    ???????????????????????????????????????????????????????????
    ?                                                         ?
    ? 2:45 PM                                                 ?
???????????????????????????????????????                      ?
?  Token Still Valid                  ?                      ?
?  Status: ? VALID                   ?                      ?
?  Time remaining: 15 min             ?                      ?
?  Can use in requests                ?                      ?
???????????????????????????????????????                      ?
    ?                                                         ?
    ???????????????????????????????????????????????????????????
    ?                                                         ?
    ? 3:00 PM (EXACT EXPIRATION)                              ?
???????????????????????????????????????                      ?
?  Token Expired                      ?                      ?
?  Status: ? EXPIRED                 ?                      ?
?  Cannot use anymore                 ?                      ?
?  Get 401 Unauthorized response      ?                      ?
???????????????????????????????????????                      ?
    ?                                                         ?
    ? 3:01 PM                                                 ?
???????????????????????????????????????                      ?
?  MUST LOGIN AGAIN                   ?                      ?
?  POST /api/auth/login               ?                      ?
?  Get new token                      ?                      ?
???????????????????????????????????????                      ?
    ?                                                         ?
    ???????????????????????????????????????????????????????????
```

---

## ?? Response Status Code Decision Tree

```
                    Request Received
                           ?
                           ?
                ???????????????????????
                ? [Authorize] needed? ?
                ???????????????????????
                      YES
                       ?
                       ?
            ????????????????????????????
            ? Header present?          ?
            ????????????????????????????
                NO           YES
                 ?            ?
            403  ?            ?
           Error ?  ?????????????????????????
                 ?  ? Token format valid?   ?
                 ?  ?????????????????????????
                 ?      NO        YES
                 ?       ?         ?
                 ?  401  ?         ?
                 ? Error ?  ????????????????????????
                 ?       ?  ? Signature valid?     ?
                 ?       ?  ? Expired? etc         ?
                 ?       ?  ????????????????????????
                 ?       ?      NO      YES
                 ?       ?       ?        ?
                 ?       ?  401  ?        ?
                 ?       ? Error ?  ????????????????????
                 ?       ?       ?  ? Role matches?    ?
                 ?       ?       ?  ????????????????????
                 ?       ?       ?      NO    YES
                 ?       ?       ?      ?      ?
                 ?       ?      403    ?      ?
                 ?       ?     Error   ?  ????????????
                 ?       ?            ?  ? 200 OK   ?
                 ?       ?            ?  ? Execute  ?
                 ?       ?            ?  ? endpoint ?
                 ?       ?            ?  ????????????
                 ???????????????????????????????
```

---

Generated: Visual Diagrams  
Last Updated: 2024
